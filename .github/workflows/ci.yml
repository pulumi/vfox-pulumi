name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  ci:
    permissions:
      contents: read
      id-token: write # For ESC secrets.
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - id: esc-secrets
        uses: pulumi/esc-action@b69006bca3bc6e514fb7e08d1593e8d9c49bd064
        with:
          environment: github-secrets/pulumi-vfox-pulumi
          oidc-organization: pulumi
          oidc-auth: true
          oidc-requested-token-type: urn:pulumi:token-type:access_token:organization
      - uses: jdx/mise-action@146a28175021df8ca24f8ee1828cc2a60f980bd5 # v3
        with:
          github_token: ${{ steps.esc-secrets.outputs.PULUMI_BOT_TOKEN }}
      - run: mise run ci
        env:
          GITHUB_TOKEN: ${{ steps.esc-secrets.outputs.PULUMI_BOT_TOKEN }}

  integration:
    permissions:
      contents: read
      id-token: write # For ESC secrets.
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - id: esc-secrets
        uses: pulumi/esc-action@b69006bca3bc6e514fb7e08d1593e8d9c49bd064
        with:
          environment: github-secrets/pulumi-vfox-pulumi
          oidc-organization: pulumi
          oidc-auth: true
          oidc-requested-token-type: urn:pulumi:token-type:access_token:organization
      - run: mkdir integration-cache
      - uses: jdx/mise-action@146a28175021df8ca24f8ee1828cc2a60f980bd5 # v3
        with:
          # Need to install mise and the repo tools
          install: true
          cache: true
          cache_save: false
          log_level: debug
          github_token: ${{ steps.esc-secrets.outputs.PULUMI_BOT_TOKEN }}
      - run: mise plugin link --force vfox-pulumi .
      - uses: jdx/mise-action@146a28175021df8ca24f8ee1828cc2a60f980bd5 # v3
        with:
          cache: false
          mise_toml: |
            [tools]
            "vfox-pulumi:pulumi/pulumi-local" = "0.1.6"
            "vfox-pulumi:pulumi/pulumi-tls" = "latest"
            "vfox-pulumi:equinix/pulumi-equinix" = "0.6.0"
          working_directory: integration-cache
          github_token: ${{ steps.esc-secrets.outputs.PULUMI_BOT_TOKEN }}
          experimental: true
      - run: cd integration-cache && pulumi-resource-local --version

  integration-cache:
    needs: integration
    permissions:
      contents: read
      id-token: write # For ESC secrets.
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - id: esc-secrets
        uses: pulumi/esc-action@b69006bca3bc6e514fb7e08d1593e8d9c49bd064
        with:
          environment: github-secrets/pulumi-vfox-pulumi
          oidc-organization: pulumi
          oidc-auth: true
          oidc-requested-token-type: urn:pulumi:token-type:access_token:organization
      - run: mkdir integration-cache
      - uses: jdx/mise-action@146a28175021df8ca24f8ee1828cc2a60f980bd5 # v3
        with:
          # Need to install mise and the repo tools
          install: true
          cache: true
          cache_save: false
          log_level: debug
      - run: mise plugin link --force vfox-pulumi .
      - uses: jdx/mise-action@146a28175021df8ca24f8ee1828cc2a60f980bd5 # v3
        with:
          cache: true
          mise_toml: |
            [tools]
            "vfox-pulumi:pulumi/pulumi-local" = "0.1.6"
            "vfox-pulumi:pulumi/pulumi-tls" = "latest"
            "vfox-pulumi:equinix/pulumi-equinix" = "0.6.0"
          working_directory: integration-cache
          github_token: ${{ steps.esc-secrets.outputs.PULUMI_BOT_TOKEN }}
          experimental: true
      - run: cd integration-cache && pulumi-resource-local --version
