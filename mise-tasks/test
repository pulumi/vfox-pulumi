#!/usr/bin/env bash

#MISE description="Run backend plugin tests - test plugin linking and basic functionality"
set -euo pipefail

# Link the plugin for testing
mise plugin link --force pulumi-plugins .

# Clear cache to ensure fresh testing
mise cache clear

# Test that the plugin can list tools (this should work even if no tools are available)
echo "Testing plugin linking and basic functionality..."

# Try to list available versions for a test tool
# Note: This will likely fail until you implement the backend methods
# Replace pulumi-resource-local with a real tool name your backend supports
TEST_TOOL="pulumi/pulumi-local"
TOOL_NAME="pulumi-resource-local"

echo "Testing version listing for ${TEST_TOOL}..."
if mise ls-remote pulumi-plugins:${TEST_TOOL} 2>/dev/null; then
    echo "✓ Version listing works"
else
    echo "⚠ Version listing failed - implement backend_list_versions.lua for your backend"
fi

# Test installation if versions are available
echo "Testing installation..."
if mise install pulumi-plugins:${TEST_TOOL}@latest 2>/dev/null; then
    echo "✓ Installation works"

    # Test that the tool can be executed
    if mise exec pulumi-plugins:${TEST_TOOL}@latest -- ${TOOL_NAME} --version 2>/dev/null; then
        echo "✓ Tool execution works"
    else
        echo "⚠ Tool execution failed - check backend_exec_env.lua implementation"
    fi
else
    echo "⚠ Installation failed - implement backend_install.lua for your backend"
fi

echo "✓ Basic plugin structure tests completed"
echo "Note: Replace pulumi-resource-local with a real tool and implement the backend methods"
